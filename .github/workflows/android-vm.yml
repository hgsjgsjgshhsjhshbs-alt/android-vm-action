name: Android Container V2 (Docker + Native Root)

on:
  workflow_dispatch:

jobs:
  run-container:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install ADB
        run: |
          sudo apt-get update
          sudo apt-get install -y adb

      - name: Start Docker Android (Android 10 - Root Supported)
        # Using budtmo/docker-android with 'google_apis' image which allows native ADB ROOT
        run: |
          echo "Pulling Docker Image..."
          docker pull budtmo/docker-android:emulator_10.0
          
          echo "Starting Container..."
          # Port 5555 forwarded to host for ADB
          # EMULATOR_DEVICE: Samsung Galaxy S10
          # SYS_IMG: google_apis (Critical for Root availability, 'playstore' images block root)
          docker run -d -p 5555:5555 -p 6080:6080 \
            -e EMULATOR_DEVICE="Samsung Galaxy S10" \
            -e WEB_VNC=true \
            -e ADB_POLLING=true \
            --device /dev/kvm \
            --name android-container \
            budtmo/docker-android:emulator_10.0
            
      - name: Wait for Device Boot
        timeout-minutes: 15
        run: |
          echo "Resetting ADB..."
          adb disconnect
          adb kill-server
          adb start-server
          
          echo "Waiting for ADB connection..."
          # Loop until device is connected
          until adb connect localhost:5555; do
            sleep 5
            echo "Retrying connection..."
          done
          
          echo "Device Connected. Verification..."
          adb devices -l
          
          echo "Waiting for Boot Complete..."
          # Use -s localhost:5555 to avoid 'more than one device' error
          adb -s localhost:5555 wait-for-device
          while [ "$(adb -s localhost:5555 shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
            echo "Booting..."
            sleep 5
          done
          echo "Boot Complete!"

      - name: Enable Native Root
        run: |
          echo "Enabling ADB Root..."
          adb -s localhost:5555 root
          # ADB root restarts the daemon on device, we must reconnect
          sleep 5
          adb connect localhost:5555 || true
          adb -s localhost:5555 wait-for-device
          echo "Root Access Verified:"
          adb -s localhost:5555 shell whoami

      - name: Setup RustDesk (Device Owner Mode)
        run: |
          echo "Downloading RustDesk 1.4.4..."
          # Using verified GitHub link from user (v1.4.4 for stability)
          curl -L -o rustdesk.apk "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-universal-signed.apk"
          
          echo "Installing RustDesk..."
          adb install rustdesk.apk
          
          echo "Setting RustDesk as DEVICE OWNER (Silent Permissions)..."
          # This command grants full administrative control, bypassing permission prompts
          # Note: We use the correct receiver path for RustDesk
          adb shell dpm set-device-owner com.rustdesk.rustdesk/.receiver.DeviceOwnerReceiver || echo "Device Owner Method might need custom APK, trying classic permissions first..."
          
          # Classic Permissions Backup (Just in case Device Owner fails on this ROM)
          adb shell pm grant com.rustdesk.rustdesk android.permission.WRITE_EXTERNAL_STORAGE || true
          adb shell pm grant com.rustdesk.rustdesk android.permission.READ_EXTERNAL_STORAGE || true
          adb shell pm grant com.rustdesk.rustdesk android.permission.RECORD_AUDIO || true
          adb shell appops set com.rustdesk.rustdesk SYSTEM_ALERT_WINDOW allow || true
          adb shell appops set com.rustdesk.rustdesk PROJECT_MEDIA allow || true
          
          echo "Launching RustDesk..."
          adb shell monkey -p com.rustdesk.rustdesk 1

      - name: Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --hostname=github-runner-android-container --authkey=${{ secrets.TAILSCALE_AUTHKEY }}
          echo "Authenticated!"
          echo "TAILSCALE IP ADDRESS:"
          tailscale ip -4

      - name: Keep Alive (Manual Mode)
        run: |
          echo "=========================================================="
          echo "           SETUP COMPLETE - CONTAINER MODE (V2)           "
          echo "=========================================================="
          echo "1. Connect via ADB / Scrcpy using the Tailscale IP above."
          echo "2. Device: Docker Container (Android 10 / Rooted)."
          echo "=========================================================="
          while true; do sleep 60; done
