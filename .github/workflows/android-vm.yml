name: Android VM (Custom APK)

on: 
  workflow_dispatch:

jobs:
  run-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale (Login Link will appear here)
        run: |
          echo "=================================================================================="
          echo "PLEASE CLICK THE LINK BELOW TO AUTHENTICATE TAILSCALE:"
          echo "=================================================================================="
          sudo tailscale up --hostname=github-runner-android
          echo "Authenticated successfully!"
          echo "TAILSCALE IP ADDRESS:"
          tailscale ip -4

      - name: Install Socat
        run: sudo apt-get update && sudo apt-get install -y socat

      - name: Run Android Emulator and Expose via Tailscale
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          profile: pixel_5
          ram-size: 4096M
          disk-size: 8000M
          # Use swiftshader for better compatibility in headless
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            export GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
            # Forward Host Port 10000 -> Emulator Port 5555
            # We use 10000 because 5555 is already taken by the emulator process
            echo "Starting Socat Port Forwarding..."
            socat TCP-LISTEN:10000,fork,bind=0.0.0.0 TCP:127.0.0.1:5555 &
            
            echo "----------------------------------------------------------"
            # AnyDesk Removed by User Request
            echo "Skipping AnyDesk..."
            echo "Setup Complete. Device Ready."
            
            echo "=========================================================="
            echo "Tailscale is active."
            echo "You can check your Tailscale Admin Console for the IP of this runner."
            echo "Or use the IP printed below:"
            tailscale ip -4
            echo "=========================================================="
            
            echo "Installing RustDesk (Custom Rooted Build)..."
            # Download Artifact from successful run
            gh run download 20523027266 -n rustdesk-custom-apk --dir ./custom-apk
            unzip ./custom-apk/app-release.apk -d ./extracted_apk || mv ./custom-apk/app-release.apk ./rustdesk.apk
            
            # Installation
            adb install rustdesk.apk || echo "RustDesk Install Failed"
            
            echo "Granting RustDesk Permissions (Package: com.rustdesk.rustdesk)..."
            # 1. Storage
            adb shell pm grant com.rustdesk.rustdesk android.permission.WRITE_EXTERNAL_STORAGE || true
            adb shell pm grant com.rustdesk.rustdesk android.permission.READ_EXTERNAL_STORAGE || true
            # 2. Audio
            adb shell pm grant com.rustdesk.rustdesk android.permission.RECORD_AUDIO || true
            # 3. System Alert (Overlay)
            adb shell appops set com.rustdesk.rustdesk SYSTEM_ALERT_WINDOW allow || true
            # 4. Screen Capture (Media Projection) - Critical
            adb shell appops set com.rustdesk.rustdesk PROJECT_MEDIA allow || true
            
            # Enable Accessibility for Input Control
            adb shell settings put secure enabled_accessibility_services com.rustdesk.rustdesk/com.rustdesk.rustdesk.AccessibilityService
            adb shell settings put secure accessibility_enabled 1
            
            echo "Launching RustDesk..."
            adb shell monkey -p com.rustdesk.rustdesk 1 || true
            
            echo "Waiting for RustDesk to generate ID..."
            sleep 10
            
            echo "=========================================================="
            echo "           RUSTDESK CONNECTION DETAILS                    "
            echo "=========================================================="
            # Extract ID from the config file (requires root/su)
            # Path might vary, trying standard paths:
            RD_ID=$(adb shell "cat /data/data/com.rustdesk.rustdesk/shared_prefs/com.rustdesk.rustdesk_preferences.xml 2>/dev/null | grep 'id' || echo 'ID_NOT_FOUND'")
            
            # Fallback: Check Logcat if file access fails
            if [[ "$RD_ID" == *"ID_NOT_FOUND"* ]]; then
               echo "Trying to fetch ID from Logcat..."
               adb logcat -d | grep "ID:" | tail -n 5
            else
               echo "Raw Config Data: $RD_ID"
            fi
            
            echo "Password (Fixed): 123123123"
            echo "=========================================================="
            
            echo "=========================================================="
            echo "           SETUP COMPLETE - MANUAL MODE                   "
            echo "=========================================================="
            echo "1. Connect via ADB / Scrcpy using the Tailscale IP above."
            echo "2. Open RustDesk manually."
            echo "3. Click 'Start Service' and grant permissions if asked."
            echo "4. Copy the ID/Password yourself."
            echo "=========================================================="
            
            # Keep alive for 6 hours (21600 seconds)
            echo "Keeping system alive for USER usage..."
            while true; do sleep 60; done
