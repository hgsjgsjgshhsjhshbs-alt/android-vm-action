name: Android VM (Custom APK)

on: 
  workflow_dispatch:

jobs:
  run-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale (Login Link will appear here)
        run: |
          echo "=================================================================================="
          echo "PLEASE CLICK THE LINK BELOW TO AUTHENTICATE TAILSCALE:"
          echo "=================================================================================="
          sudo tailscale up --hostname=github-runner-android
          echo "Authenticated successfully!"
          echo "TAILSCALE IP ADDRESS:"
          tailscale ip -4

      - name: Install Socat
        run: sudo apt-get update && sudo apt-get install -y socat

      - name: Run Android Emulator and Expose via Tailscale
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          profile: Nexus 4
          ram-size: 4096M
          disk-size: 8000M
          # Use swiftshader for better compatibility in headless
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            # Forward Host Port 10000 -> Emulator Port 5555
            # We use 10000 because 5555 is already taken by the emulator process
            echo "Starting Socat Port Forwarding..."
            socat TCP-LISTEN:10000,fork,bind=0.0.0.0 TCP:127.0.0.1:5555 &
            
            echo "----------------------------------------------------------"
            # AnyDesk Removed by User Request
            echo "Skipping AnyDesk..."
            echo "Setup Complete. Device Ready."
            
            echo "=========================================================="
            echo "Tailscale is active."
            echo "You can check your Tailscale Admin Console for the IP of this runner."
            echo "Or use the IP printed below:"
            tailscale ip -4
            echo "=========================================================="
            
            # ------------------------------------------------------------------
            # Plan C: Web Scrcpy (Browser Control)
            # ------------------------------------------------------------------
            echo "Setting up ws-scrcpy for Browser Control..."
            
            # Install Node.js dependencies
            # Install and Start ws-scrcpy (Chained to preserve directory context)
            git clone https://github.com/NetrisTV/ws-scrcpy.git
            
            echo "Starting ws-scrcpy installation and server..."
            
            # ------------------------------------------------------------------
            # CUSTOMIZATION: Inject Mobile-Friendly CSS
            # ------------------------------------------------------------------
            echo "Injecting Custom Mobile UI Styles..."
            # Using a simplified CSS block to avoid sed parsing issues
            # 1. Dark Theme & Centered Layout
            # 2. Big Buttons for Links
            # 3. Hide 'devtools', 'shell', 'proxy', 'files', 'tiny'
            # 4. Highlight 'Configure' (Green) and 'H264 Converter' (Blue)
            
            CUSTOM_CSS="<style>body{background-color:#121212!important;color:#fff!important;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0}a{text-decoration:none;color:#fff!important;display:block;padding:20px;margin:10px;background:#333;border-radius:15px;font-size:1.2rem;text-align:center;width:85%;max-width:350px;box-shadow:0 4px 6px rgba(0,0,0,0.5);transition:transform 0.1s}a:active{transform:scale(0.98)}a[href*='devtools'],a[href*='shell'],a[href*='proxy'],a[href*='files'],a[href*='tiny']{display:none!important}a[href*='configure']{background:#28a745!important;font-weight:bold}a[href*='H264']{background:#007bff!important;font-weight:bold;font-size:1.4rem}h3,div{text-align:center;width:100%}.device-state{font-size:2rem;margin-bottom:20px}</style>"
            
            # Using sed to insert style before </head> in src/client/index.html
            # We run this INSIDE the ws-scrcpy directory
            # ------------------------------------------------------------------
            
            # Run commands sequentially with error handling
            cd ws-scrcpy
            
            # Robust Styling: Find index.html anywhere and inject CSS (Fail-safe)
            echo "Attempting to inject custom styles..."
            find . -name "index.html" -type f -exec sed -i "s|</head>|$CUSTOM_CSS</head>|" {} + || echo "WARNING: Style injection failed, proceeding with default UI."
            
            # Start Server (Critical Path)
            echo "Starting server..."
            # Explicitly change directory again in the same command chain to ensure context
            cd ws-scrcpy && npm install && npm run dist && nohup npm start > ../ws-scrcpy.log 2>&1 &
            
            # Wait for server to start
            sleep 15
            
            echo "Checking background server status..."
            cat ws-scrcpy.log || echo "Log file not created."
            
            echo "=========================================================="
            echo "           WEB ACCESS READY (PLAN C)                      "
            echo "=========================================================="
            echo "1. Connect your phone using Tailscale."
            echo "2. Open your browser and go to:"
            echo "   http://$(tailscale ip -4):8000"
            echo "=========================================================="
            
            # Go back to root
            cd ..
            
            echo "Device is ready and accessible."
            # ------------------------------------------------------------------
            
            # Keep alive for 6 hours (21600 seconds)
            echo "Keeping system alive for USER usage..."
            while true; do sleep 60; done
