name: Android VM with Remote Access

on: 
  workflow_dispatch:

jobs:
  run-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Tailscale
        run: curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale (Login Link will appear here)
        run: |
          echo "=================================================================================="
          echo "PLEASE CLICK THE LINK BELOW TO AUTHENTICATE TAILSCALE:"
          echo "=================================================================================="
          sudo tailscale up --hostname=github-runner-android
          echo "Authenticated successfully!"

      - name: Install Socat
        run: sudo apt-get update && sudo apt-get install -y socat

      - name: Run Android Emulator and Expose via Tailscale
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          profile: pixel_5
          ram-size: 4096M
          disk-size: 8000M
          # Use swiftshader for better compatibility in headless
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            # Forward Host Port 10000 -> Emulator Port 5555
            # We use 10000 because 5555 is already taken by the emulator process
            echo "Starting Socat Port Forwarding..."
            socat TCP-LISTEN:10000,fork,bind=0.0.0.0 TCP:127.0.0.1:5555 &
            
            echo "----------------------------------------------------------"
            # AnyDesk Removed by User Request
            echo "Skipping AnyDesk..."
            echo "Setup Complete. Device Ready."
            
            echo "=========================================================="
            echo "Tailscale is active."
            echo "You can check your Tailscale Admin Console for the IP of this runner."
            echo "Or use the IP printed below:"
            tailscale ip -4
            echo "=========================================================="
            
            echo "Installing RustDesk (User Version 1.4.4)..."
            curl -L -o rustdesk.apk "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-universal-signed.apk"
            adb install rustdesk.apk || echo "RustDesk Install Failed"
            
            echo "Granting RustDesk Permissions (Package: com.rustdesk.rustdesk)..."
            # 1. Storage
            adb shell pm grant com.rustdesk.rustdesk android.permission.WRITE_EXTERNAL_STORAGE || true
            adb shell pm grant com.rustdesk.rustdesk android.permission.READ_EXTERNAL_STORAGE || true
            # 2. Audio
            adb shell pm grant com.rustdesk.rustdesk android.permission.RECORD_AUDIO || true
            # 3. System Alert (Overlay)
            adb shell appops set com.rustdesk.rustdesk SYSTEM_ALERT_WINDOW allow || true
            # 4. Screen Capture (Media Projection) - Critical
            adb shell appops set com.rustdesk.rustdesk PROJECT_MEDIA allow || true
            
            # Enable Accessibility for Input Control
            adb shell settings put secure enabled_accessibility_services com.rustdesk.rustdesk/com.rustdesk.rustdesk.AccessibilityService
            adb shell settings put secure accessibility_enabled 1
            
            echo "Launching RustDesk to generate ID..."
            adb shell monkey -p com.rustdesk.rustdesk 1 || true
            sleep 10
            
            echo "Attempting Auto-Click on 'Start Service'..."
            # Center-Top area
            adb shell input tap 540 500
            adb shell input tap 540 600
            sleep 2
            
            echo "Enabling 'Pointer Location' (Visual Coordinates)..."
            adb shell settings put system pointer_location 1
            
            echo "Installing Smart AutoClicker (Helper Tool)..."
            curl -L -o autoclicker.apk "https://github.com/Nain57/Smart-AutoClicker/releases/download/v1.5.2/Smart.AutoClicker-v1.5.2.apk"
            adb install autoclicker.apk || echo "AutoClicker Install Failed"
            
            echo "=========================================================="
            echo "           CLIPBOARD MONITOR (COPY ID TO LOG)             "
            echo "=========================================================="
            echo "Instructions:"
            echo "1. Connect via RustDesk (if possible) or ADB."
            echo "2. If you see the RustDesk ID, click the 'Copy' icon."
            echo "3. The ID will appear below automatically within 10 seconds."
            echo "=========================================================="
            
            echo "Starting Clipboard Monitor Loop..."
            while true; do
              echo "Checking Clipboard..."
              # Dump clipboard info
              adb shell service call clipboard 1 || echo "Clipboard Read Error"
              # Or try dumpsys if service call is messy
              # adb shell dumpsys clipboard | grep "mPrimaryClip" || true
              sleep 10
            done
